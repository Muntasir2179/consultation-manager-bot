{% load static %}

<!DOCTYPE html>
<html lang="en" data-layout="vertical" data-topbar="light" data-sidebar="dark" data-sidebar-size="lg"
  data-sidebar-image="none" data-preloader="disable">

<head>
  <meta charset="utf-8" />
  <title>Schedules Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta content="Premium Multipurpose Admin & Dashboard Template" name="description" />
  <meta content="Themesbrand" name="author"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico"/>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css" />

  <script src="/static/js/layout.js"></script>
  <link href="/static/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
  <link href="/static/css/icons.min.css" rel="stylesheet" type="text/css" />
  <link href="/static/css/app.min.css" rel="stylesheet" type="text/css" />
  <link href="/static/css/custom.min.css" rel="stylesheet" type="text/css" />
</head>

<body>
  <div id="layout-wrapper">
    <header id="page-topbar">
      <div class="layout-width">
        <div class="navbar-header">
          <div class="d-flex">
            <!-- expander button -->
            <button type="button" class="btn btn-sm px-3 fs-16 header-item vertical-menu-btn topnav-hamburger"
              id="topnav-hamburger-icon">
              <span class="hamburger-icon">
                <span></span>
                <span></span>
                <span></span>
              </span>
            </button>
          </div>

          <div class="d-flex align-items-center">
            <!-- full screen button -->
            <div class="ms-1 header-item d-none d-sm-flex">
              <button type="button" class="btn btn-icon btn-topbar btn-ghost-secondary rounded-circle"
                data-toggle="fullscreen">
                <i class="bx bx-fullscreen fs-22"></i>
              </button>
            </div>

            <!-- theme toggler button -->
            <div class="ms-1 header-item d-none d-sm-flex">
              <button type="button" class="btn btn-icon btn-topbar btn-ghost-secondary rounded-circle light-dark-mode">
                <i class="bx bx-moon fs-22"></i>
              </button>
            </div>

            <!-- profile starts -->
            <div class="dropdown ms-sm-3 header-item topbar-user">
              <button type="button" class="btn" id="page-header-user-dropdown" data-bs-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
                <span class="d-flex align-items-center">
                  <img class="rounded-circle header-profile-user" src="static/images/users/avatar-1.jpg"
                    alt="Header Avatar" />
                  <span class="text-start ms-xl-2">
                    <span class="d-none d-xl-inline-block ms-1 fw-medium user-name-text">Anna Adame</span>
                  </span>
                </span>
              </button>

              <div class="dropdown-menu dropdown-menu-end">
                <h6 class="dropdown-header">Welcome Anna!</h6>
                <a class="dropdown-item" href="signout/"><i
                    class="mdi mdi-logout text-muted fs-16 align-middle me-1"></i>
                  <span class="align-middle" data-key="t-logout">Logout</span></a>
              </div>
            </div>
            <!-- profile ends -->
          </div>
        </div>
      </div>
    </header>

    <!-- sidebar -->
    <div class="app-menu navbar-menu">
      <div class="navbar-brand-box">
        <a href="index.html" class="logo logo-dark">
          <span class="logo-sm">
            <img src="/static/images/logo-sm.png" alt="" height="22" />
          </span>
          <span class="logo-lg">
            <img src="/static/images/logo-dark.png" alt="" height="17" />
          </span>
        </a>
        <a href="index.html" class="logo logo-light">
          <span class="logo-sm">
            <img src="/static/images/logo-sm.png" alt="" height="22" />
          </span>
          <span class="logo-lg">
            <img src="/static/images/logo-light.png" alt="" height="17" />
          </span>
        </a>
        <button type="button" class="btn btn-sm p-0 fs-20 header-item float-end btn-vertical-sm-hover"
          id="vertical-hover">
          <i class="ri-record-circle-line"></i>
        </button>
      </div>

      <div id="scrollbar">
        <div class="container-fluid">
          <div id="two-column-menu"></div>
          <ul class="navbar-nav" id="navbar-nav">
            <li class="menu-title"><span data-key="t-menu">Menu</span></li>

            <li class="nav-item">
              <a class="nav-link menu-link" href="index.html">
                <i class="ri-honour-line"></i>
                <span data-key="t-widgets">Schedules</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Start right Content here -->
    <div class="main-content">
      <div class="page-content">
        <div class="container-fluid">
          <div class="row">
            <div class="col-12">
              <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                <h4 class="mb-sm-0">Schedules</h4>
                <div class="page-title-right">
                  <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item">
                      <a href="javascript: void(0);">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item active">Schedules</li>
                  </ol>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">Schedules</h5>
                </div>
                <div class="card-body">
                  <table id="example" class="table table-bordered dt-responsive nowrap table-striped align-middle" style="width: 100%">
                    <thead>
                      <tr>
                        <th data-ordering="false">User ID</th>
                        <th data-ordering="false">Name</th>
                        <th data-ordering="false">Phone</th>
                        <th data-ordering="false">Age</th>
                        <th>Appointment Date</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Status</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for customer in content %}
                      <tr id="customer-{{ customer.user_id }}">
                        <td>{{customer.user_id}}</td>
                        <td>{{customer.person_name}}</td>
                        <td>{{customer.phone_number}}</td>
                        <td>{{customer.age}}</td>
                        <td>{{customer.appointment_date}}</td>
                        <td>{{customer.appointment_time}}</td>
                        <td>{{customer.appointment_end_time}}</td>
                        <td><span class="badge bg-danger">{{customer.status}}</span></td>
                        <td>
                          <div class="dropdown d-inline-block">
                            <button class="btn btn-soft-secondary btn-sm dropdown" type="button"
                              data-bs-toggle="dropdown" aria-expanded="false">
                              <i class="ri-more-fill align-middle"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                              <li>
                                <a href="#!" class="dropdown-item view-item-btn" data-bs-toggle="modal" data-bs-target="#viewCustomerModal"
                                   data-userid="{{customer.user_id}}"
                                   data-name="{{customer.person_name}}"
                                   data-phone="{{customer.phone_number}}"
                                   data-age="{{customer.age}}"
                                   data-appointmentdate="{{customer.appointment_date}}"
                                   data-appointmenttime="{{customer.appointment_time}}"
                                   data-appointmentendtime="{{customer.appointment_end_time}}"
                                   data-status="{{customer.status}}">
                                  <i class="ri-eye-fill align-bottom me-2 text-muted"></i> View
                                </a>
                              </li>
                              <li>
                                <a href="#!" class="dropdown-item edit-item-btn" data-bs-toggle="modal" data-bs-target="#editCustomerModal"
                                   data-userid="{{customer.user_id}}"
                                   data-name="{{customer.person_name}}"
                                   data-phone="{{customer.phone_number}}"
                                   data-age="{{customer.age}}"
                                   data-appointmentdate="{{customer.appointment_date}}"
                                   data-appointmenttime="{{customer.appointment_time}}"
                                   data-appointmentendtime="{{customer.appointment_end_time}}"
                                   data-status="{{customer.status}}">
                                  <i class="ri-pencil-fill align-bottom me-2 text-muted"></i> Edit
                                </a>
                              </li>
                              <li>
                                <a class="dropdown-item remove-item-btn" data-bs-toggle="modal" data-bs-target="#deleteModal" data-user-id="{{ customer.user_id }}">
                                    <i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i>
                                    Delete
                                </a>
                              </li>
                            </ul>
                          </div>
                        </td>
                      </tr>
                      {% endfor %}
                      {% comment %} view data modal {% endcomment %}
                      <div class="modal fade" id="viewCustomerModal" tabindex="-1" aria-labelledby="viewCustomerModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="viewCustomerModalLabel">Customer Details</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <p><strong>User ID:</strong> <span id="modalUserId"></span></p>
                              <p><strong>Name:</strong> <span id="modalPersonName"></span></p>
                              <p><strong>Phone Number:</strong> <span id="modalPhoneNumber"></span></p>
                              <p><strong>Age:</strong> <span id="modalAge"></span></p>
                              <p><strong>Appointment Date:</strong> <span id="modalAppointmentDate"></span></p>
                              <p><strong>Appointment Time:</strong> <span id="modalAppointmentTime"></span></p>
                              <p><strong>Appointment End Time:</strong> <span id="modalAppointmentEndTime"></span></p>
                              <p><strong>Status:</strong> <span id="modalStatus"></span></p>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                            </div>
                          </div>
                        </div>
                      </div>

                      {% comment %} Edit Modal Structure  {% endcomment %}
                      <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="editCustomerModalLabel">Edit Customer Details</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form id="editCustomerForm">
                              {% csrf_token %}
                              <div class="modal-body">
                                {% comment %} Hidden user_id field (non-editable) {% endcomment %}
                                <input type="hidden" id="editUserId" name="user_id" readonly>
                                
                                {% comment %} Editable fields {% endcomment %}
                                <div class="mb-3">
                                  <label for="editPersonName" class="form-label">Name</label>
                                  <input type="text" class="form-control" id="editPersonName" name="person_name" required>
                                </div>
                                <div class="mb-3">
                                  <label for="editPhoneNumber" class="form-label">Phone Number</label>
                                  <input type="text" class="form-control" id="editPhoneNumber" name="phone_number" required>
                                </div>
                                <div class="mb-3">
                                  <label for="editAge" class="form-label">Age</label>
                                  <input type="number" class="form-control" id="editAge" name="age" required>
                                </div>
                                <div class="mb-3">
                                  <label for="editAppointmentDate" class="form-label">Appointment Date</label>
                                  <input type="date" class="form-control" id="editAppointmentDate" name="appointment_date" required>
                                </div>
                                <div class="mb-3">
                                  <label for="editAppointmentTime" class="form-label">Appointment Time</label>
                                  <input type="time" class="form-control" id="editAppointmentTime" name="appointment_time" required>
                                </div>
                                <div class="mb-3">
                                  <label for="editAppointmentEndTime" class="form-label">Appointment End Time</label>
                                  <input type="time" class="form-control" id="editAppointmentEndTime" name="appointment_end_time" required>
                                </div>
                                <div class="mb-3">
                                  <label for="editStatus" class="form-label">Status</label>
                                  <select class="form-select" id="editStatus" name="status" required>
                                    <option value="Pending">Pending</option>
                                    <option value="Completed">Approved</option>
                                    <option value="Cancelled">Completed</option>
                                    <option value="Cancelled">Rejected</option>
                                  </select>
                                </div>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Update</button>
                              </div>
                            </form>
                          </div>
                        </div>
                      </div>

                      {% comment %} delete modal {% endcomment %}
                      <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              Are you sure you want to delete this record?
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                              <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                            </div>
                          </div>
                        </div>
                      </div>

                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer class="footer">
        <div class="container-fluid">
          <div class="row">
            <div class="col-sm-6">
              <script>
                document.write(new Date().getFullYear());
              </script>
              © Muntasir
            </div>
            <div class="col-sm-6">
              <div class="text-sm-end d-none d-sm-block">
                Design & Develop by Muntasir
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </div>


  <button onclick="topFunction()" class="btn btn-danger btn-icon" id="back-to-top">
    <i class="ri-arrow-up-line"></i>
  </button>

  <div id="preloader">
    <div id="status">
      <div class="spinner-border text-primary avatar-sm" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  </div>

  {% comment %} JAVASCRIPT {% endcomment %}
  <script>
  {% comment %} view data script {% endcomment %}
  document.addEventListener("DOMContentLoaded", function() {
    var viewButtons = document.querySelectorAll('.view-item-btn');
  
    viewButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        // Get customer details from data attributes
        var userId = this.getAttribute('data-userid');
        var name = this.getAttribute('data-name');
        var phone = this.getAttribute('data-phone');
        var age = this.getAttribute('data-age');
        var appointmentDate = this.getAttribute('data-appointmentdate');
        var appointmentTime = this.getAttribute('data-appointmenttime');
        var appointmentEndTime = this.getAttribute('data-appointmentendtime');
        var status = this.getAttribute('data-status');
  
        // Populate the modal with customer details
        document.getElementById('modalUserId').textContent = userId;
        document.getElementById('modalPersonName').textContent = name;
        document.getElementById('modalPhoneNumber').textContent = phone;
        document.getElementById('modalAge').textContent = age;
        document.getElementById('modalAppointmentDate').textContent = appointmentDate;
        document.getElementById('modalAppointmentTime').textContent = appointmentTime;
        document.getElementById('modalAppointmentEndTime').textContent = appointmentEndTime;
        document.getElementById('modalStatus').textContent = status;
      });
    });
  });

  {% comment %} edit data script {% endcomment %}
  document.addEventListener("DOMContentLoaded", function() {
    var editButtons = document.querySelectorAll('.edit-item-btn');
  
    editButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        // Get customer details from data attributes
        var userId = this.getAttribute('data-userid');
        var name = this.getAttribute('data-name');
        var phone = this.getAttribute('data-phone');
        var age = this.getAttribute('data-age');
        var appointmentDate = this.getAttribute('data-appointmentdate');
        var appointmentTime = this.getAttribute('data-appointmenttime');
        var appointmentEndTime = this.getAttribute('data-appointmentendtime');
        var status = this.getAttribute('data-status');
  
        // Populate the edit form with customer details
        document.getElementById('editUserId').value = userId;
        document.getElementById('editPersonName').value = name;
        document.getElementById('editPhoneNumber').value = phone;
        document.getElementById('editAge').value = age;
        document.getElementById('editAppointmentDate').value = appointmentDate;
        document.getElementById('editAppointmentTime').value = appointmentTime;
        document.getElementById('editAppointmentEndTime').value = appointmentEndTime;
        document.getElementById('editStatus').value = status;
      });
    });
  
    // Handle form submission (you can adjust this according to your backend setup)
    document.getElementById('editCustomerForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Here you would typically make an AJAX call to update the customer data in your backend
      // For demonstration, let's just log the form data
  
      var formData = new FormData(this);
      console.log(Object.fromEntries(formData));
  
      // Close the modal after submission
      var editModal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
      editModal.hide();
  
      // Optionally, refresh the page or the customer table to show updated data
    });
  });

  {% comment %} delete data {% endcomment %}
  document.addEventListener('DOMContentLoaded', function () {
    let userIdToDelete = null;

    // Triggered when delete button is clicked
    document.querySelectorAll('.remove-item-btn').forEach(function(button) {
      button.addEventListener('click', function() {
        userIdToDelete = this.getAttribute('data-user-id');
      });
    });

    // Triggered when the "Confirm Delete" button in the modal is clicked
    document.getElementById('confirmDelete').addEventListener('click', function() {
      if (userIdToDelete) {
        // Perform the deletion via a POST request
        fetch(`/delete-customer/${userIdToDelete}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Hide the modal
            let modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();
            
            // Remove the deleted row from the table without reloading the page
            let row = document.getElementById(`customer-${userIdToDelete}`);
            row.parentNode.removeChild(row);
          }
        });
      }
    });
  });
  </script>
  <script src="/static/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/static/libs/simplebar/simplebar.min.js"></script>
  <script src="/static/libs/node-waves/waves.min.js"></script>
  <script src="/static/libs/feather-icons/feather.min.js"></script>
  <script src="/static/js/pages/plugins/lord-icon-2.1.0.js"></script>
  <script src="/static/js/plugins.js"></script>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

  {% comment %} datatable js {% endcomment %}
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

  <script src="/static/js/pages/datatables.init.js"></script>
  <script src="/static/js/app.js"></script>
</body>

</html>